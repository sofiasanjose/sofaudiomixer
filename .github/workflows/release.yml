name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-26
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install create-dmg dependencies
        run: brew install graphicsmagick imagemagick

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"

          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate to keychain
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access the certificate
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add keychain to search list (prepend to ensure it's found first)
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | tr -d '"')

          # Verify certificate is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Update ExportOptions with Team ID
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          sed -i '' "s/TEAM_ID_PLACEHOLDER/$APPLE_TEAM_ID/g" ExportOptions.plist
          cat ExportOptions.plist

      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Setting version to $VERSION"

          # Update MARKETING_VERSION (e.g., 1.1.0)
          sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = $VERSION/g" FineTune.xcodeproj/project.pbxproj

          # Update CURRENT_PROJECT_VERSION (build number) using run number for uniqueness
          BUILD_NUMBER=${{ github.run_number }}
          sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = $BUILD_NUMBER/g" FineTune.xcodeproj/project.pbxproj

          echo "Version: $VERSION, Build: $BUILD_NUMBER"

      - name: Build archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild -project FineTune.xcodeproj \
            -scheme FineTune \
            -configuration Release \
            -archivePath build/FineTune.xcarchive \
            archive \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID"

      - name: Export archive
        run: |
          xcodebuild -exportArchive \
            -archivePath build/FineTune.xcarchive \
            -exportPath build/ \
            -exportOptionsPlist ExportOptions.plist

          # Verify the app is signed
          codesign -dv --verbose=4 build/FineTune.app

      - name: Create DMG
        run: |
          # create-dmg creates a nicely formatted DMG with Applications symlink
          npx create-dmg build/FineTune.app build/ --overwrite || true

          # Rename to include version from tag
          VERSION=${GITHUB_REF_NAME#v}
          DMG_NAME="FineTune-${VERSION}.dmg"

          # Find and rename the created DMG (create-dmg names it "AppName Version.dmg")
          mv build/*.dmg "build/${DMG_NAME}"

          echo "DMG_NAME=${DMG_NAME}" >> $GITHUB_ENV
          echo "Created: build/${DMG_NAME}"

      - name: Sign DMG
        env:
          CERT_IDENTITY: ${{ secrets.CERT_IDENTITY }}
        run: |
          # Sign the DMG with Developer ID
          codesign --force --sign "$CERT_IDENTITY" "build/$DMG_NAME"

          # Verify signature
          codesign -dv --verbose=2 "build/$DMG_NAME"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit DMG for notarization and wait for result
          xcrun notarytool submit "build/$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket to the DMG
          xcrun stapler staple "build/$DMG_NAME"

          # Verify stapling
          xcrun stapler validate "build/$DMG_NAME"

      - name: Update appcast with Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          # Download Sparkle tools
          SPARKLE_VERSION="2.8.1"
          curl -L -o sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
          mkdir -p sparkle_tools
          tar -xf sparkle.tar.xz -C sparkle_tools

          # Write private key to temp file (generate_appcast reads from file)
          echo -n "$SPARKLE_PRIVATE_KEY" > "$RUNNER_TEMP/sparkle_private_key"

          # Create Release folder with the DMG (generate_appcast scans this folder)
          mkdir -p Release
          cp "build/$DMG_NAME" "Release/"

          # Run generate_appcast to update appcast.xml with proper EdDSA signature
          sparkle_tools/bin/generate_appcast \
            --ed-key-file "$RUNNER_TEMP/sparkle_private_key" \
            --download-url-prefix "https://github.com/ronitsingh10/FineTune/releases/download/v${VERSION}/" \
            -o appcast.xml \
            Release/

          # Clean up private key
          rm -f "$RUNNER_TEMP/sparkle_private_key"

          echo "Updated appcast.xml with version ${VERSION}"
          cat appcast.xml

      - name: Commit updated appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast for ${GITHUB_REF_NAME}" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/FineTune-*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
